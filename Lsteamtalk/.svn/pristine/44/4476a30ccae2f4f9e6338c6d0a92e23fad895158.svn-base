
package com.lesso.daoImpl;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.Map.Entry;

import com.lesso.beans.IMUser;
import com.lesso.dao.IMUserDao;
import com.lesso.util.DBUtils;



public class IMUserDaoImpl extends BaseDaoImpl<IMUser> implements IMUserDao{
    public IMUser findIMUser(String username){
        try{
     	   Connection conn = DBUtils.createConn();
     	   String sql ="select * from IMUser where name= '"+username+"'";
     	   PreparedStatement ps = DBUtils.getPs(conn, sql);
 			ResultSet rs = ps.executeQuery();
 			IMUser mp = new IMUser();
 			while(rs.next()){
 				mp.setCreated(Long.parseLong(rs.getString("Created")));
 				mp.setSex(Integer.parseInt(rs.getString("sex")));
 				mp.setId(Integer.parseInt(rs.getString("id")));
 				mp.setName(rs.getString("name"));
 				mp.setNick(rs.getString("nick"));
 				mp.setPassword(rs.getString("Password"));
 				mp.setSalt(rs.getString("Salt"));
 				mp.setDomain(rs.getString("domain"));
 				mp.setUpdated(Long.parseLong(rs.getString("updated")));
 				mp.setDepartId(Integer.parseInt(rs.getString("departId")));
 				mp.setPhone(rs.getString("phone"));
 				mp.setEmail(rs.getString("email"));
 				mp.setAvatar(rs.getString("avatar"));
 				mp.setStatus(Integer.parseInt(rs.getString("status")));
 				mp.setPush_shield_status(Integer.parseInt(rs.getString("push_shield_status")));
 				mp.setSign_info(rs.getString("sign_info"));
 			}
 			DBUtils.close(ps);
 			DBUtils.close(conn);
 			return mp;
        }catch(Exception e){
     	   e.printStackTrace();
    		   return null;
        }
     }
     
     public int saveIMUser(IMUser imuser){
     	try{
     		Connection conn = DBUtils.createConn();
     		String sql ="insert into IMUser (sex,name,domain,nick,password,salt,phone,email,avatar,departId,status,"
     				+ "created,updated,push_shield_status,sign_info)"
     				+ " values('"+imuser.getSex()+"','"+imuser.getName()+"','"+imuser.getDomain()+"','"
     						+ imuser.getNick()+"','"+imuser.getPassword()+"','"+imuser.getSalt()+"','"+imuser.getPhone()+"','"+imuser.getEmail()+"','"
     								+imuser.getAvatar()+"','"+imuser.getDepartId()+"','"+imuser.getStatus()+"','"+imuser.getCreated() +"',"
     										+ "'"+imuser.getUpdated()+"','"+imuser.getPush_shield_status()+"','"+imuser.getSign_info()+"')";
     		Statement st=conn.createStatement();		    				
 			int ds = st.executeUpdate(sql);

 			DBUtils.close(conn);
 			if(st != null){
 				st.close();
 			}
 			return ds;
     	}catch(Exception e){
     		e.printStackTrace();
     		return 0;
     	}
 		
     	
     }
     
     
 	/**
 	 * 分页查询列表信息 
 	 */
 	public List<IMUser> findByPagination(int currentPage, int pageSize  ,Map<String ,Object> m)
 			throws Exception {
 		Connection conn = DBUtils.createConn();
 		String sql = " select * from IMUser  where 1=1 ";
 		
 		Set<Entry<String, Object>> set = m.entrySet();
 		Iterator io = set.iterator();
 		while (io.hasNext()) {
 			Map.Entry<String, Object> me = (Map.Entry<String, Object>) io.next();
 			if("name".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("nick".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("phone".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("email".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("domain".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " = '" + me.getValue() +"'";
 			}
 			if("departId".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " = '" + me.getValue() +"'";
 			}
 			if("sort".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " order by " + me.getValue() ;
 			}
 			if("order".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " " + me.getValue();
 			}			
 		}
 		sql = sql +" limit " + (currentPage-1)*pageSize +" , "  + pageSize ;
 		PreparedStatement ps = DBUtils.getPs(conn, sql);
 		ResultSet rs = ps.executeQuery();
 		
 		List<IMUser> ulist = new ArrayList<IMUser>();
 		while(rs.next()){
 			IMUser mp = new IMUser();
 			String ds = rs.getString("nick");
 			mp.setCreated(Long.parseLong(rs.getString("Created")));
				mp.setSex(Integer.parseInt(rs.getString("sex")));
				mp.setId(Integer.parseInt(rs.getString("id")));
				mp.setName(rs.getString("name"));
				mp.setNick(rs.getString("nick"));
				mp.setPassword(rs.getString("Password"));
				mp.setSalt(rs.getString("Salt"));
				mp.setDomain(rs.getString("domain"));
				mp.setUpdated(Long.parseLong(rs.getString("updated")));
				mp.setDepartId(Integer.parseInt(rs.getString("departId")));
				mp.setPhone(rs.getString("phone"));
				mp.setEmail(rs.getString("email"));
				mp.setAvatar(rs.getString("avatar"));
				mp.setStatus(Integer.parseInt(rs.getString("status")));
				mp.setPush_shield_status(Integer.parseInt(rs.getString("push_shield_status")));
				mp.setSign_info(rs.getString("sign_info"));
				ulist.add(mp);
 		}
 		return ulist;
 	}
 	
 	/**
 	 * 查询表中的所有记录数 
 	 */
 	public int getTotal(Map<String ,Object> m) throws Exception {
 		
 		Connection conn = DBUtils.createConn();
 		String sql = " select count(*) from IMUser  where 1=1 ";
 		
 		Set<Entry<String, Object>> set = m.entrySet();
 		Iterator io = set.iterator();
 		while (io.hasNext()) {
 			Map.Entry<String, Object> me = (Map.Entry<String, Object>) io.next();
 			if("name".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("nick".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("phone".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("email".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " like '%"+ me.getValue()  +"%'" ;
 			}
 			if("domain".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " = '" + me.getValue() +"'";
 			}
 			if("departId".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " and " + me.getKey() + " = '" + me.getValue() +"'";
 			}
 			if("sort".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " order by " + me.getValue() ;
 			}
 			if("order".equals(me.getKey()) && !"".equals(me.getValue())){
 				sql += " " + me.getValue();
 			}			
 		}	
 		PreparedStatement ps = DBUtils.getPs(conn, sql);
 		ResultSet rs = ps.executeQuery();		
 		int count = 0 ;
 		if(rs.next()){
 			
 			count = rs.getInt(1);
 		}
 		return count;
 	}

	@Override
	public boolean updateIMAdmin(IMUser imuser) {
		try {
			this.update(imuser);
			return true;
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
			return false;
		}
	
	}

	@Override
	public boolean deleteIMAdmin(int id) {
		// TODO Auto-generated method stub
		try {
			this.delete(id);
			return true;
		} catch (Exception e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
			return false;
		}
	}
}
