//初始化
$(function () {
//	alert(IsPC());   
    InitPage();
    $("#ConfirmBtn").click(function () {
        var checkPayPwdIsValid = true;
        var checkPayNewPwdIsValid = CheckPayNewPwd();
        var checkPayPwdConfirmIsValid = CheckPayPwdConfirm();

        checkPayPwdIsValid = SetEmpty("#textPayPwd", "请输入原支付密码", "#labelPayPwd", checkPayPwdIsValid);
        checkPayNewPwdIsValid = SetEmpty("#textPayNewPwd", "请输入新的支付密码", "#labelPayNewPwd", checkPayNewPwdIsValid);
        checkPayPwdConfirmIsValid = SetEmpty("#textPayPwdConfirm", "请再次输入新的支付密码", "#labelPayPwdConfirm", checkPayPwdConfirmIsValid);

        if( checkPayPwdIsValid && checkPayNewPwdIsValid && checkPayPwdConfirmIsValid){
            var loginame = getQueryString("name");
			$.ajax({
				type:'post',
				url:'../privilegemgmt/users.action',
				cache:false , 
				dataType:'json',
				data:{
					method:'xgmima',
					loginame:loginame,
					oldpassword:$('#textPayPwd').val(),
				    newpassword:$('#textPayPwdConfirm').val()
				} ,
				success:function(r){
					if(r[0] ==null){
						alert("内部错误,请与信息管理中心联系,谢谢！");
					}else{
						var da = r[0];
						if(!da.hasError){
							if(!IsPC()){
								 myObj.jsFinishPassword("1");  
							}
							var url ="../html/mp.html";
							url=encodeURI(encodeURI(url));
							window.location.href=url;
						}else{
							alert("内部错误,请与信息管理中心联系,谢谢！");
						}
					}

				},
				error:function(r){
					alert("内部错误,请与信息管理中心联系,谢谢！");
				}
			});
        

		}else{
		   return false;
		}
    });




});

function getQueryString(name) {
var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
var r = window.location.search.substr(1).match(reg);
if (r != null) return unescape(r[2]); return null;
} 

function SetEmpty(sendId, errorText, sendLabelId, isValid) {
    if (typeof ($(sendId).val()) == "undefined" || $(sendId).val() == "" || $(sendId).val() == null) {
        $(sendId).parent().parent().find(".error").text(errorText).show();
        isValid = false;
    }
    IsHidden(isValid, sendLabelId);
    return isValid;
}

function IsHidden(isValid, sendLabelId) {
    if (isValid) {
        $(sendLabelId).css("display", "none").text();
    }
    else {
        $(sendLabelId).css("display", "inline-block").text();
    }
}

function InitPage() {
    IsHidden(true, "#labelPayPwd");
    IsHidden(true, "#labelPayNewPwd");
    IsHidden(true, "#labelPayPwdConfirm");
    	$("#textPayPwd").keyup(function(){
	       ClickPayPwd();
	     });
		$("#textPayNewPwd").keyup(function(){
	       ClickPayNewPwd();
	     });
		$("#textPayPwdConfirm").keyup(function(){
	       ClickPayPwdConfirm();
	     });

}

function CheckPayNewPwd() {
    var $payNewPwd = $("#textPayNewPwd");
    var payNewPwdText = $("#textPayNewPwd").val();
    var isValid = true;
    $payNewPwd.parent().parent().parent().find(".error").text("");
    if (typeof ($("#textPayNewPwd").val()) != "undefined" && $("#textPayNewPwd").val() != "" && $("#textPayNewPwd").val() != null) {
        var Format = /^([\x21-\x7eA-Za-z0-9]){6,12}$/;
        var PureNum = /^(?!\d+$)/;
        if (Format.test(payNewPwdText) == false || PureNum.test(payNewPwdText) == false) {
            $payNewPwd.parent().parent().find(".error").text("与登录密码区分，6-12位大小写字母、数字或符号的密码，勿用纯数字").show();
            isValid = false;
        }
    }
    IsHidden(isValid, "#labelPayNewPwd");
    return isValid;
}

function CheckPayPwdConfirm() {
    var $payPwdConfirm = $("#textPayPwdConfirm");
    var payPwdConfirmTxet = $("#textPayPwdConfirm").val();
    var isValid = true;
    $payPwdConfirm.parent().parent().find(".error").text("");
    if (typeof ($("#textPayPwdConfirm").val()) != "undefined" && $("#textPayPwdConfirm").val() != "" && $("#textPayPwdConfirm").val() != null) {
        if ($.trim($("#textPayPwdConfirm").val()) != $.trim($("#textPayNewPwd").val())) {
            $payPwdConfirm.parent().parent().find(".error").text("输入密码不一致").show();
            isValid = false;
        }
    }
    IsHidden(isValid, "#labelPayPwdConfirm");
    return isValid;
}

function ClickPayPwd() {
    $("#labelPayPwd").css("display", "none").text();
}

function ClickPayNewPwd() {
    $("#labelPayNewPwd").css("display", "none").text();
}

function ClickPayPwdConfirm() {
    $("#labelPayPwdConfirm").css("display", "none").text();
}

//for mobile
function IsPC() {
    var userAgentInfo = navigator.userAgent;
    var Agents = ["Android", "iPhone",
                "SymbianOS", "Windows Phone",
                "iPad", "iPod"];
    var flag = true;
    for (var v = 0; v < Agents.length; v++) {
        if (userAgentInfo.indexOf(Agents[v]) > 0) {
            flag = false;
            break;
        }
    }
    return flag;
}


