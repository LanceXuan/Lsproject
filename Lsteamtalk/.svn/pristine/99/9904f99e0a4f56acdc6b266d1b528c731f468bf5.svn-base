$(function(){
	var df =$("#file0");
//	alert(df);
	$("#file0").change(function(){
		alert(123);
	    var objUrl = getObjectURL(this.files[0]) ;
	    console.log("objUrl = "+objUrl) ;
	    if (objUrl) {
	        $("#img0").attr("src", objUrl) ;
	    }
	    changeImagesSize();
	}) ;
   InitPage();	
});

function InitPage(){
	checkform();


    var flag;
    $('#t_user').datagrid({
        idField:'id',
        title:'用户列表',
        url:'../privilegemgmt/users.action?method=getlist',	
        fit:true,
		height:550,
		width:700,
	//	fitColumns:true,
		striped:true,
		loadMsg:'loading...',
		rownumbers:true,
		collapsible:true,
        remoteSort:false,
        rownumbers:true,
        width:800,
        striped: true,
        nowrap:false,
        pagination:true,
//      singleSelect:true,
//      remoteSort:false,
        rowStyler:function(index,record){
        	if(record.sex==0){
        		return "background:green";
        	}
        },
        frozenColumns:[[      //冻结列特性，不要与fitColumns特性一起使用
            {
                field:'ck',
                width:50,
                checkbox:true
            }
         ]],
         columns:[[
                   {
		         	field:'id',
		        	title:'ID',
		        	width:50,
		        	align:'center'
		           },{
                	field:'name',
                	title:'员工名',
                	width:60,
                	align:'center',
                	styler:function(value,record){
                		if(value == ''){
                			
                		}
                	}
                   },{
                	   field:'sex',
                	   title:'性别',
                	   width:50,
                	   align:'center',
                	   formatter:function(value,record){
                		   if(value == "1"){
                			   return "男";
                		   }else{
                			   return "女";
                		   }
                	   }
                   },{
                	   field:'name',
                	   title:'登录名',
                	   width:60,
                	   align:'center'
                   },{
                	   field:'nick',
                	   title:'花名',
                	   width:80,
                	   align:'center',
                	   formatter:function(value,record){
                		
                			 //  alert(value);
                			   return value;
                	   }
                   },{
                	   field:'phone',
                	   title:'手机',
                	   width:80,
                	   align:'center'
                   },{
                	   field:'email',
                	   title:'email',
                	   align:'center',
                	   width:80
                   },{
                	   field:'departId',
                	   title:'部门',
                	   width:50,
                	   align:'center'
                   }
         ]],
         pageSize:10,
         pageList:[5,10,15,20,50],
            toolbar :'#tb'
    });
	
    $('#depAdd').click(function(){
    	append();
    });
     
    
    $("#btn1").click(function(){
    	var requestobj ={
    			name:$('#myform').find('input[name=empname]').val(),
    			sex:$('#myform').find("input[name=empsex]:checked").val(),
    			nick:$('#myform').find('input[name=nicktxt]').val(),
    			phone:$('#myform').find('input[name=phonetxt]').val(),
    			email:$('#myform').find("input[name=emailtxt]").val(),
    	        departId:$('#myform').find('input[name=depId]').val(),
    	        password:$('#myform').find('input[name=password]').val()   	        
    	}
		$.ajax({
			type:'post',
			url:'../privilegemgmt/users.action?method=save',
			cache:false , 
			dataType:'json',
			data:requestobj,
			success:function(r){
				if(r[0] ==null){
					alert("不存在该用户,如有疑问请与信息管理中心联系！");
				}else{
					var da = r[0];
					if(!da.hasError){
						var url ="home.jsp";
						url=encodeURI(encodeURI(url));
						window.location.href=url;
					}else{
						alert("内部错误,请与信息管理中心联系,谢谢！");
					}
				}

			},
			error:function(r){
				alert("内部错误,请与信息管理中心联系,谢谢！");
			}
		});
    	
    	//3关闭窗口
		$('#mydialog').dialog('close');
    });

    
    $("#btn2").click(function(){
    	$('#mydialog').dialog('close');
    });
}

function append(){
	flag='add';
	//1清空表单数据
	$('#myform').form('clear');
	//2打开窗口
	$('#mydialog').dialog('open');
	
}


//form表单验证
function checkform(){
	//数值验证组件 
	$('#age').numberbox({
		min:0 , 
		max:70 ,
		required:true , 
		missingMessage:'年龄必填!' ,
		precision:0
	});
	
	//日期组件
	$('#empbirthplace').datebox({
		required:true , 
		missingMessage:'生日必填!' ,
		editable:false
	});
	
	//日期组件
	$('#emparrivedate').datebox({
		required:true , 
		missingMessage:'生日必填!' ,
		editable:false
	});
	
	$('#salary').numberbox({
		min:1000 , 
		max:200000 ,
		required:true , 
		missingMessage:'薪水必填!' ,
		precision:0
	});
	
	
}


//建立一個可存取到該file的url
function getObjectURL(file) {
    var url = null ;
    if (window.createObjectURL!=undefined) { // basic
        url = window.createObjectURL(file) ;
    } else if (window.URL!=undefined) { // mozilla(firefox)
        url = window.URL.createObjectURL(file) ;
    } else if (window.webkitURL!=undefined) { // webkit or chrome
        url = window.webkitURL.createObjectURL(file) ;
    }
    return url ;
}

function  changeImagesSize(){     
    var imageArray = document.getElementById("dsf").getElementsByTagName("img");    
    for(var i=0;i<imageArray.length;i++)    
    {   
       if (imageArray[i].width>80) {   
          var srcWidth  = imageArray[i].width;   
          var srcHeight = imageArray[i].height;   
          imageArray[i].style.width="80px";    
          imageArray[i].style.height=(srcHeight*imageArray[i].width)/srcWidth;    
       }     
        
    }   
}  


function hjg(value){
	alert(123);
    var objUrl = getObjectURL(value.files[0]) ;
    console.log("objUrl = "+objUrl) ;
    if (objUrl) {
        $("#img0").attr("src", objUrl) ;
    }
    changeImagesSize();
}

//js方法：序列化表单 			
function serializeForm(form){
	var obj = {};
	$.each(form.serializeArray(),function(index){
		if(obj[this['name']]){
			obj[this['name']] = obj[this['name']] + ','+this['value'];
		} else {
			obj[this['name']] =this['value'];
		}
	});
	return obj;
}



function ajaxFileUpload()  
{  
  
//$("#loading")  
//    .ajaxStart(function(){  
//        $(this).show();  
//    })//开始上传文件时显示一个图片  
//    .ajaxComplete(function(){  
//        $(this).hide();  
//    });//文件上传完成将图片隐藏起来  
      
   $.ajaxFileUpload({  
             url:"demo/test.action",             //需要链接到服务器地址  
             secureuri:false,  
             fileElementId:'uploadFile',                         //文件选择框的id属性  
             dataType: 'json',                                     //服务器返回的格式，可以是json  
             success: function (data, status)             //相当于java中try语句块的用法  
             {     
             //alert(data);       //data是从服务器返回来的值     
                 $('#result').html('上传图片成功!请复制图片地址<br/>'+data.src);  

             },  
             error: function (data, status, e)             //相当于java中catch语句块的用法  
             {  
                 $('#result').html('上传图片失败');  
             }  
           }  
         );  
}  




