$('#chadepId').combotree({
	url : 'privilegemgmt/dept.action?method=TreeDept',
	width : 220,
	checkbox : false,
	multiple : false,
	onSelect : function(node) {
		getUserList(node.id);
	}
});
$("#liOption").multiselect2side({
	selectedPosition : 'right',
	moveOptions : false,
	labelsx : '待选区',
	labeldx : '已选区'
});
function getUserList(deptid) {
	$.ajax({
				type : 'post',
				url : 'privilegemgmt/users.action',
				cache : false,
				dataType : 'json',
				data : {
					method : "getdepartUser",
					departId : deptid,
					page : -1,
					rows : -1
				},
				success : function(r) {
					var ysValue = $('#liOptionms2side').html();
					var str = "<select name='liOption[]' id='liOption' multiple='multiple' size='10'>";
					var data = r.rows;
					for (var i = 0; i < data.length; i++) {
						str += "<option value='" + data[i].id + "'>"
								+ data[i].nick + "</option>";
					}
					str += "</select>";
					$("#sel").empty();
					$("#sel").html(str);
					$("#liOption").multiselect2side({
						selectedPosition : 'right',
						moveOptions : false,
						labelsx : '待选区',
						labeldx : '已选区'
					});
					$('#liOptionms2side').html(ysValue);
				},
				error : function(r) {
					alert("内部错误,请与信息管理中心联系,谢谢！");
				}
			});
}

function praseHtml(){
	var firstImg = "";
	var dom=$('<div>').append(getContent());
	firstImg = dom.find("img").attr('src'); 
	return firstImg;
}

function  getChoseList(){
	var list = "";
	$("#liOptionms2side option").each(function() {    
		list += $(this).val()+",";
	});
	return list.substring(0, list.length-1);
}

function checkNotice(){
	if($("#title").val()==''){
		alert("请填写标题");
		return false;
	}
	if(getChoseList() == null ||getChoseList() == '') {
		alert("请选择接收人");
		return false;
	}
	if(getContent()==''){
		alert("请填写内容");
		return false;
	}
	return true;
}
function sendNotice(){
	if(checkNotice()){
		var reviceor = getChoseList();
		$.ajax({
			type : 'post',
			url : 'privilegemgmt/ccNotice.action?reviceor='+reviceor,
			cache : false,
			dataType : 'json',
			data : {
				method:"saveCcNotice",
				content : getContent(),
				firstImg : praseHtml(),
				title : $("#title").val()
			},
			success : function(r) {
				if(r[0].logMsg == "fail"){
					alert("内部错误,请与信息管理中心联系,谢谢！");
				}else{
					alert("发送成功！");
					conSend(r[0].logMsg);
					closeWindow();
					
				}
			},
			error : function(r) {
				alert("内部错误,请与信息管理中心联系,谢谢！");
			}
		});
	}
}

function conSend(id){
	var list = getChoseList().split(",");
	var data = {
		req_id:$("#userId").val(),
		to_id:list[0],
		msg_type:7,
		msg_content:""
	};
	$.ajax({
		type: "post",
		url: "http://192.168.4.178:8400/api/sendmsg",
		data: data,
		dataType: "json",
		success: function(data) {
			alert("ok");
		}
    });
}

function   closeWindow()   { 
	  
	  window.open('','_parent',''); 
	  
	  window.close(); 
	  
	  }  